rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    // Checks if the requesting user is the owner of the document.
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Checks if a user has the 'teacher' role by looking for their UID in the roles_teacher collection.
    function isTeacher() {
      return exists(/databases/$(database)/documents/roles_teacher/$(request.auth.uid));
    }
    
    // Checks if a user has a student profile document in the 'users' collection.
    function isStudent() {
        return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // --- Profile Collections ---

    // Student user profiles.
    match /users/{userId} {
      // Teachers can list students to manage assignments, and get a specific student's profile.
      allow list, get: if isTeacher();
      // A student can read their own profile.
      allow get: if isOwner(userId);
      // A student can create and delete their own profile.
      allow create, delete: if isOwner(userId);
      // A student can update their own profile. A teacher can only update the 'assignedLessons' field.
      allow update: if isOwner(userId) || (isTeacher() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['assignedLessons']));
    }
    
    // Teacher user profiles.
    match /teachers/{teacherId} {
        // Students can read teacher profiles (e.g., for availability).
        // The teacher who owns the profile can also read it.
        // Only the teacher can create or update their own profile.
        allow read: if isStudent() || isOwner(teacherId);
        allow write: if isOwner(teacherId);
    }

    // --- App Content Collections ---

    // Lessons created by teachers.
    match /lessons/{lessonId} {
      // Any authenticated user can read lessons.
      allow read: if request.auth != null;
      // Only a teacher can create a lesson, and they must be the owner.
      allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid;
      // Only the teacher who owns the lesson can update or delete it.
      allow update, delete: if isTeacher() && resource.data.teacherId == request.auth.uid;
    }

    // Quizzes created by teachers.
    match /quizzes/{quizId} {
        // Any authenticated user can read quizzes.
        allow read: if request.auth != null;
        // Only a teacher can create, update, or delete a quiz, and they must be the owner.
        allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid;
        allow update, delete: if isTeacher() && resource.data.teacherId == request.auth.uid;
    }
    

    // --- Booking and Scheduling ---

    // Tutoring sessions booked by students.
    match /tutoring_sessions/{sessionId} {
      // Students can only create sessions for themselves.
      allow create: if isStudent() && request.resource.data.studentId == request.auth.uid;
      // Only the student who booked it or the teacher it's booked with can read or update it.
      allow read, update: if (isStudent() && resource.data.studentId == request.auth.uid) || 
                             (isTeacher() && resource.data.teacherId == request.auth.uid);
      // Deletion is not allowed to preserve session history.
      allow delete: if false;

      // Users can only list sessions that they are a part of (either as student or teacher).
      allow list: if (isStudent() && request.query.where[0][0] == 'studentId' && request.query.where[0][2] == request.auth.uid) ||
                     (isTeacher() && request.query.where[0][0] == 'teacherId' && request.query.where[0][2] == request.auth.uid);
    }

    // --- Role and System Collections ---

    // Collection that maps UIDs to teacher roles.
    match /roles_teacher/{userId} {
      // Nobody can read this collection directly; its existence is checked by the isTeacher() function.
      allow read: if false;
      // Writes are disallowed from the client to prevent privilege escalation. Must be managed server-side.
      allow write: if false;
    }

    // Collection for mapping unique usernames to UIDs for login.
    match /usernames/{username} {
        // Reads are only allowed to check for a username's existence.
        allow get: if request.auth != null;
        // List operations are disallowed for security.
        allow list: if false;
        // Only a new user creating their own username mapping can write.
        allow create: if request.resource.data.uid == request.auth.uid;
        // Updates/deletes are disallowed to prevent users from hijacking usernames.
        allow update, delete: if false;
    }

    // --- Progress Tracking (Future-proofing) ---
    // Subcollection for student progress, nested under the user's document.
    match /users/{studentId}/progress/{progressId} {
      // Only the student can read or write their own progress records.
      allow read, write: if isOwner(studentId);
    }
  }
}

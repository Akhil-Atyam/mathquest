/**
 * @fileoverview Firestore Security Rules for the MathQuest application.
 *
 * Core Philosophy:
 * This ruleset enforces a combination of user-ownership and role-based access control.
 * User-specific data (students, teachers) is secured using path-based ownership.
 * Lessons and Quizzes are publicly readable, but writable only by teachers, using the teacherId.
 * Tutoring sessions are secured by validating either the student or the teacher has access.
 *
 * Data Structure:
 * - /students/{studentId}: Student profiles, owned by the student.
 * - /teachers/{teacherId}: Teacher profiles, owned by the teacher.
 * - /lessons/{lessonId}: Lesson data, created and managed by teachers.
 * - /quizzes/{quizId}: Quiz data.
 * - /questions/{questionId}: Question data.
 * - /quizScores/{quizScoreId}: Quiz score data, private to the student.
 * - /tutoringSessions/{tutoringSessionId}: Tutoring session data, accessible to the student and teacher involved.
 *
 * Key Security Decisions:
 * - Students and Teachers can only read or write their own profiles.
 * - Lessons can be read by anyone, but only created/modified by teachers.
 * - QuizScores are private to each student
 * - TutoringSessions require denormalized studentId and teacherId for access control.
 * - Data shape is generally not validated, focusing on authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description: Enforces student profile ownership. Students can only read and write their own profiles.
     * @path: /students/{studentId}
     * @allow: (create) User with UID 'student_abc' creates a document at /students/student_abc.
     * @deny: (create) User with UID 'student_xyz' attempts to create a document at /students/student_abc.
     * @principle: Enforces document ownership for all operations.
     */
    match /students/{studentId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if false;

      allow create: if isOwner(studentId) && request.resource.data.id == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description: Enforces teacher profile ownership. Teachers can only read and write their own profiles.
     * @path: /teachers/{teacherId}
     * @allow: (create) User with UID 'teacher_abc' creates a document at /teachers/teacher_abc.
     * @deny: (create) User with UID 'teacher_xyz' attempts to create a document at /teachers/teacher_abc.
     * @principle: Enforces document ownership for all operations.
     */
    match /teachers/{teacherId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if false;

      allow create: if isOwner(teacherId) && request.resource.data.id == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description: Allows anyone to read lessons, but only teachers can create, update, or delete them.
     * @path: /lessons/{lessonId}
     * @allow: (get) Any user can read any lesson.
     * @allow: (create) A teacher with UID 'teacher_abc' creates a lesson with teacherId 'teacher_abc'.
     * @deny: (create) A student with UID 'student_abc' attempts to create a lesson.
     * @principle: Public read access with owner-only writes.
     */
    match /lessons/{lessonId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return request.auth != null && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }
      
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.teacherId);
      allow delete: if isExistingOwner(resource.data.teacherId);
    }

     /**
      * @description: Allows anyone to read quizzes, but only teachers can create, update, or delete them.
      * @path: /quizzes/{quizId}
      * @allow: (get) Any user can read any quiz.
      * @allow: (create) A teacher with UID 'teacher_abc' creates a quiz with teacherId 'teacher_abc'.
      * @deny: (create) A student with UID 'student_abc' attempts to create a quiz.
      * @principle: Public read access with owner-only writes.
      */
    match /quizzes/{quizId} {
        function isSignedIn() {
            return request.auth != null;
        }

        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }

    /**
     * @description: Allows anyone to read questions, but only teachers can create, update, or delete them.
     * @path: /questions/{questionId}
     * @allow: (get) Any user can read any question.
     * @allow: (create) A teacher with UID 'teacher_abc' creates a question with quizId 'quiz_abc'.
     * @deny: (create) A student with UID 'student_abc' attempts to create a question.
     * @principle: Public read access with owner-only writes.
     */
    match /questions/{questionId} {
        function isSignedIn() {
            return request.auth != null;
        }

        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }

    /**
     * @description: Enforces quiz score ownership. Students can only read and write their own quiz scores.
     * @path: /quizScores/{quizScoreId}
     * @allow: (create) User with UID 'student_abc' creates a document at /quizScores/quizScore_abc with studentId 'student_abc'.
     * @deny: (create) User with UID 'student_xyz' attempts to create a document at /quizScores/quizScore_abc.
     * @principle: Enforces document ownership for all operations.
     */
    match /quizScores/{quizScoreId} {
      function isOwner(studentId) {
        return request.auth != null && request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(request.auth.uid);
      allow list: if false;

      allow create: if request.auth != null && request.resource.data.studentId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.studentId);
      allow delete: if isExistingOwner(resource.data.studentId);
    }

    /**
     * @description: Tutoring session data, accessible to the student and teacher involved.
     * @path: /tutoringSessions/{tutoringSessionId}
     * @allow: (get) Student 'student_abc' can read tutoring session document where studentId == 'student_abc'.
     * @allow: (get) Teacher 'teacher_abc' can read tutoring session document where teacherId == 'teacher_abc'.
     * @deny: (get) Student 'student_xyz' attempts to read tutoring session that does not involve them.
     * @principle: Shared Access (Closed Collaborators).
     */
    match /tutoringSessions/{tutoringSessionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn() && (resource.data.studentId == request.auth.uid || resource.data.teacherId == request.auth.uid);
      allow list: if isSignedIn() && (resource.data.studentId == request.auth.uid || resource.data.teacherId == request.auth.uid);

      allow create: if isSignedIn() && (request.resource.data.studentId == request.auth.uid || request.resource.data.teacherId == request.auth.uid);
      allow update: if isSignedIn() && (resource.data.studentId == request.auth.uid || resource.data.teacherId == request.auth.uid);
      allow delete: if isSignedIn() && (resource.data.studentId == request.auth.uid || resource.data.teacherId == request.auth.uid);
    }
  }
}
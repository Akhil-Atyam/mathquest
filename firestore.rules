
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default deny all access to prevent unsecured collections
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Users can only read, create, or update their own profile
    match /users/{userId} {
      allow read, update, create: if request.auth.uid == userId;
    }
    
    // Any authenticated user can read teacher profiles to see availability.
    // Only a teacher can write to their own profile.
    match /teachers/{teacherId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == teacherId;
    }

    // All authenticated users can read lessons.
    match /lessons/{lessonId} {
      allow read: if request.auth != null;
      // Teachers can create lessons.
      allow create: if request.auth.uid == request.resource.data.teacherId && exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
      // The teacher who created the lesson can update or delete it.
      allow update, delete: if request.auth.uid == resource.data.teacherId;
    }

    // Quizzes can be read by any authenticated user, but only modified by their creator.
    match /quizzes/{quizId} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == request.resource.data.teacherId && exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
      allow update, delete: if request.auth.uid == resource.data.teacherId;
    }
    
    // All authenticated users can read tutoring sessions
    match /tutoring_sessions/{sessionId} {
        allow read: if request.auth != null;
    }

    // Authenticated users can create/update a session if they are a student booking it
    match /tutoring_sessions/{sessionId} {
        allow write: if request.auth.uid in request.resource.data.studentIds;
    }
    
    // Student-led group study sessions
    match /group_study_sessions/{sessionId} {
      // Any authenticated user can read any session
      allow read: if request.auth != null;
      // A student can create a session, or update it if they are the host
      allow write: if request.auth.uid == request.resource.data.hostId;
    }


    // Allow lookup of usernames for login, but creation is restricted.
    match /usernames/{username} {
      allow read: if request.auth != null;
      // A user can only create a username document that maps to their own UID.
      allow create: if request.auth.uid == request.resource.data.uid;
    }
    
    // Allow teachers to get their role document
    match /roles_teacher/{userId} {
        allow read, write: if request.auth.uid == userId;
    }

    // Students can update their own progress documents
    match /users/{studentId}/progress/{progressId} {
      allow write, read: if if request.auth.uid == studentId;
    }
  }
}

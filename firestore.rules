/**
 * @fileoverview Firestore Security Rules for MathQuest application.
 *
 * Core Philosophy:
 * This ruleset enforces a combination of user-ownership and role-based access control.
 * User-specific data is strictly controlled by the owning user. Public data (lessons) is readable by all, but write access is restricted.
 * Role-based access uses a Document Based Access Control (DBAC) using the `/roles_teacher/{userId}` to grant teacher role.
 *
 * Data Structure:
 * - /users/{userId}: Student user profiles.
 * - /teachers/{teacherId}: Teacher profiles.
 * - /lessons/{lessonId}: Lesson data (public read).
 * - /lessons/{lessonId}/quizzes/{quizId}: Quizzes for each lesson.
 * - /tutoring_sessions/{sessionId}: Tutoring sessions involving students and teachers.
 * - /users/{userId}/progress/{progressId}: Student progress records.
 * - /roles_teacher/{userId}:  Documents denoting teacher role.
 *
 * Key Security Decisions:
 * - Students can only access their own profile data and progress records.
 * - Teachers can access their own profile data and tutoring sessions they are involved in.
 * - Lessons are publicly readable, but only specific users can create, update, or delete them.
 * - Listing users or teachers is disallowed for privacy reasons.
 * - Denormalization is used to store authorization data within documents for efficient rule evaluation.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description: Restricts access to user profiles, allowing only the owner to read and write.
     * @path: /users/{userId}
     * @allow: User 'user123' (create) can create their profile if request.auth.uid == 'user123'.
     * @deny: User 'user456' (create) cannot create a profile under /users/user123.
     * @principle: Enforces user ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing all users

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource.data.id == userId;
      allow delete: if isOwner(userId) && resource.data.id == userId;
    }

    /**
     * @description: Restricts access to teacher profiles, allowing only the owner to read and write.
     * @path: /teachers/{teacherId}
     * @allow: Teacher 'teacher123' (create) can create their profile if request.auth.uid == 'teacher123'.
     * @deny: User 'user456' (create) cannot create a a profile under /teachers/teacher123.
     * @principle: Enforces user ownership for teacher profiles.
     */
    match /teachers/{teacherId} {
      function isTeacherOwner(teacherId) {
          return request.auth != null && request.auth.uid == teacherId;
      }
      
      function isTeacher() {
        return exists(/databases/$(database)/documents/roles_teacher/$(request.auth.uid));
      }

      allow get: if isTeacherOwner(teacherId);
      allow list: if false; // Prevent listing all teachers

      allow create: if isTeacherOwner(teacherId) && request.resource.data.id == teacherId && isTeacher();
      allow update: if isTeacherOwner(teacherId) && resource.data.id == teacherId && isTeacher();
      allow delete: if isTeacherOwner(teacherId) && resource.data.id == teacherId && isTeacher();
    }

    /**
     * @description: Allows public read access to lessons, but restricts write access.
     * @path: /lessons/{lessonId}
     * @allow: Any user (get, list) can read lesson data.
     * @deny: User 'user123' (create) cannot create lessons without proper authorization. // TODO: Add logic for authorized lesson creators.
     * @principle: Implements public read with owner-only writes for lessons.
     */
    match /lessons/{lessonId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description: Restricts access to quizzes, allowing only authorized users to create, update, or delete them.
     * @path: /lessons/{lessonId}/quizzes/{quizId}
     * @allow: Any user (get, list) can read quiz data.
     * @deny: User 'user123' (create) cannot create quizzes without proper authorization. // TODO: Add logic for authorized lesson creators.
     * @principle: Secures quizzes by restricting write access to authorized users only.
     */
    match /lessons/{lessonId}/quizzes/{quizId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description: Restricts access to tutoring sessions, allowing only the student or teacher involved to read and write.
     * @path: /tutoring_sessions/{sessionId}
     * @allow: Student 'student123' (get) can read session data if tutoringSession.studentId == 'student123'.
     * @allow: Teacher 'teacher456' (get) can read session data if tutoringSession.teacherId == 'teacher456'.
     * @deny: User 'user789' (get) cannot read session data if they are not the student or teacher.
     * @principle: Enforces shared access for tutoring sessions based on studentId and teacherId.
     */
    match /tutoring_sessions/{sessionId} {
      function isParticipant(studentId, teacherId) {
        return request.auth != null && (request.auth.uid == studentId || request.auth.uid == teacherId);
      }

      function isExistingParticipant(studentId, teacherId) {
          return isParticipant(studentId, teacherId) && resource != null;
      }

      allow get: if isParticipant(resource.data.studentId, resource.data.teacherId);
      allow list: if false; // Listing all tutoring sessions is not permitted.

      allow create: if isParticipant(request.resource.data.studentId, request.resource.data.teacherId);
      allow update: if isExistingParticipant(resource.data.studentId, resource.data.teacherId);
      allow delete: if isExistingParticipant(resource.data.studentId, resource.data.teacherId);
    }

    /**
     * @description: Restricts access to student progress records, allowing only the owner to read and write.
     * @path: /users/{studentId}/progress/{progressId}
     * @allow: Student 'student123' (get) can read their own progress data.
     * @deny: Student 'student456' (get) cannot read 'student123's progress data.
     * @principle: Enforces user ownership for student progress records.
     */
    match /users/{studentId}/progress/{progressId} {
      function isOwner(studentId) {
        return request.auth != null && request.auth.uid == studentId;
      }

      allow get, list: if isOwner(studentId);

      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isOwner(studentId) && resource.data.studentId == studentId;
      allow delete: if isOwner(studentId) && resource.data.studentId == studentId;
    }

    /**
     * @description: Enables document-based access control for assigning the teacher role based on DBAC.
     * @path: /roles_teacher/{userId}
     * @allow: User with UID matching {userId} can create this document for themselves if they provide the correct secret code.
     * @deny: Other users cannot create this document.
     * @principle: Implements Document Based Access Control (DBAC).
     */
      match /roles_teacher/{userId} {
        function isSignedIn() {
          return request.auth != null;
        }

        allow get: if isSignedIn();
        allow list: if false;

        allow create: if request.auth.uid == userId;
        allow update: if false;
        allow delete: if request.auth.uid == userId;
      }
  }
}

    
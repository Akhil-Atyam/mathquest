/**
 * @fileoverview Firestore Security Rules for MathQuest application.
 *
 * Core Philosophy:
 * This ruleset enforces a combination of user-ownership and role-based access control.
 * User-specific data is strictly controlled by the owning user. Public data (lessons) is readable by all, but write access is restricted.
 * Role-based access uses a Document Based Access Control (DBAC) using the `/roles_teacher/{userId}` to grant teacher role.
 *
 * Data Structure:
 * - /users/{userId}: Student user profiles.
 * - /teachers/{teacherId}: Teacher profiles.
 * - /lessons/{lessonId}: Lesson data (public read).
 * - /lessons/{lessonId}/quizzes/{quizId}: Quizzes for each lesson.
 * - /tutoring_sessions/{sessionId}: Tutoring sessions involving students and teachers.
 * - /users/{userId}/progress/{progressId}: Student progress records.
 * - /roles_teacher/{userId}:  Documents denoting teacher role.
 * - /usernames/{username}: Maps a username to a user's email for login.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Restricts access to student user profiles.
     * Only the authenticated user who owns the profile can perform any operation on it.
     * This follows the principle of user data ownership.
     * @path /users/{userId}
     */
    match /users/{userId} {
      /**
       * Helper function to check if the requesting user is the owner of the document.
       * @param {string} userId - The ID of the user document being accessed.
       * @returns {boolean} True if the requester's UID matches the document's userId.
       */
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      // Allow read, update, and delete only for the document owner.
      allow get, update, delete: if isOwner(userId);
      // Disallow listing all user documents to protect user privacy.
      allow list: if false;
      // Allow creation only if the user is creating their own document.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
    }

    /**
     * @description Restricts access to teacher profiles.
     * Only the owning teacher can access their profile.
     * Creating, updating, or deleting requires the user to have the teacher role.
     * @path /teachers/{teacherId}
     */
    match /teachers/{teacherId} {
      /**
       * Helper function to check if the requesting user is the owner of the teacher document.
       * @param {string} teacherId - The ID of the teacher document being accessed.
       * @returns {boolean} True if the requester's UID matches the document's teacherId.
       */
      function isTeacherOwner(teacherId) {
          return request.auth != null && request.auth.uid == teacherId;
      }
      
      /**
       * Helper function to verify if the requesting user has a teacher role.
       * It checks for the existence of a corresponding document in the 'roles_teacher' collection (DBAC).
       * @returns {boolean} True if the user has a teacher role document.
       */
      function isTeacher() {
        return exists(/databases/$(database)/documents/roles_teacher/$(request.auth.uid));
      }

      // Allow a teacher to get their own profile.
      allow get: if isTeacherOwner(teacherId);
      // Allow any authenticated user to list teachers for booking purposes.
      allow list: if request.auth != null; 

      // Allow a user to create their own teacher profile.
      allow create: if isTeacherOwner(teacherId);
      // Allow teachers to update and delete their own profiles.
      allow update, delete: if isTeacherOwner(teacherId);
    }

    /**
     * @description Manages access to lessons.
     * All authenticated users can read and list lessons, making them public resources.
     * Write operations are currently disabled and would require an admin/owner role.
     * @path /lessons/{lessonId}
     */
    match /lessons/{lessonId} {
      // Allow public read access for all users.
      allow get, list: if request.auth != null;
      // Disallow all write operations for now.
      // TODO: Add owner/admin validation for write access.
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to quizzes within lessons.
     * Similar to lessons, quizzes are publicly readable by any authenticated user.
     * Write access is restricted.
     * @path /lessons/{lessonId}/quizzes/{quizId}
     */
    match /lessons/{lessonId}/quizzes/{quizId} {
      // Allow public read access for all users.
      allow get, list: if request.auth != null;
      // Disallow all write operations for now.
      // TODO: Add owner/admin validation for write access.
      allow create, update, delete: if false; 
    }

    /**
     * @description Manages access to tutoring sessions.
     * Access is restricted to the participants (student and teacher) of the session.
     * This rule prevents users from seeing sessions they are not a part of.
     * @path /tutoring_sessions/{sessionId}
     */
    match /tutoring_sessions/{sessionId} {
      /**
       * Helper function to check if the requesting user is a participant in the session.
       * @param {string} studentId - The ID of the student in the session.
       * @param {string} teacherId - The ID of the teacher in the session.
       * @returns {boolean} True if the requester's UID matches either the studentId or teacherId.
       */
      function isParticipant(studentId, teacherId) {
        return request.auth != null && (request.auth.uid == studentId || request.auth.uid == teacherId);
      }

      // Allow a user to list sessions only if they are querying by their own teacherId or studentId.
      // This is crucial for securely fetching a user's schedule.
      allow list: if request.auth != null && (request.query.where.teacherId == request.auth.uid || request.query.where.studentId == request.auth.uid);

      // Allow participants to get, create, update, and delete the session document.
      allow get: if isParticipant(resource.data.studentId, resource.data.teacherId);
      allow create: if isParticipant(request.resource.data.studentId, request.resource.data.teacherId);
      allow update, delete: if isParticipant(resource.data.studentId, resource.data.teacherId);
    }

    /**
     * @description Manages access to a student's progress records.
     * These are stored in a subcollection under the user's document to ensure
     * that only the owning student can access their own progress.
     * @path /users/{studentId}/progress/{progressId}
     */
    match /users/{studentId}/progress/{progressId} {
      /**
       * Helper function to check if the requester is the owner of the parent user document.
       * @param {string} studentId - The ID of the student (from the path).
       * @returns {boolean} True if the requester's UID matches the studentId.
       */
      function isOwner(studentId) {
        return request.auth != null && request.auth.uid == studentId;
      }

      // Allow the owner to read, list, and write their own progress records.
      allow get, list: if isOwner(studentId);
      allow create, update, delete: if isOwner(studentId) && request.resource.data.studentId == studentId;
    }

    /**
     * @description Manages the teacher role assignment collection (DBAC).
     * The existence of a document in this collection signifies that the user with that UID is a teacher.
     * @path /roles_teacher/{userId}
     */
    match /roles_teacher/{userId} {
      /**
       * Helper function to check if a user is signed in.
       * @returns {boolean} True if a user is authenticated.
       */
      function isSignedIn() {
        return request.auth != null;
      }

      // Allow any signed-in user to check if another user is a teacher.
      allow get: if isSignedIn();
      // Disallow listing all teacher roles.
      allow list: if false;

      // Allow a user to create their own teacher role document.
      // In a real app, this would be protected, e.g., by a secret code or an admin process.
      allow create: if request.auth.uid == userId;
      // Prevent updates or allow a user to remove their own role.
      allow update: if false;
      allow delete: if request.auth.uid == userId;
    }

    /**
     * @description Manages the username-to-email mapping for login purposes.
     * The document ID is the username.
     * @path /usernames/{username}
     */
    match /usernames/{username} {
      // Allow any authenticated user to read a username document to find the corresponding email for login.
      allow get: if request.auth != null;
      // Disallow listing all username mappings.
      allow list: if false;
      // Allow a user to create their own username mapping, but only if the UID in the document matches their auth UID.
      allow create: if request.auth.uid == request.resource.data.uid;
      // Disallow updates and deletes for now to prevent tampering.
      allow update, delete: if false;
    }
  }
}
